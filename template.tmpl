{{- define "model" -}}
package {{ .Package }}
  
import (
    "encoding/json"
    "github.com/goal-web/supports/logs"
    "github.com/goal-web/contracts"
    "github.com/goal-web/database/table"
    "github.com/goal-web/supports/utils"
    {{- if ne (len .Relations) 0 }}
    "github.com/goal-web/collection"
    {{- end }}
    {{- if .Model.Authenticatable }}
    "fmt"
    {{- end }}
    {{- if hasMsgComment .Model "@carbon" }}
    "github.com/golang-module/carbon/v2"
    {{- end }}
    {{- range .Imports }}
    {{ .Alias }} "{{ .Pkg }}"
    {{- end }}
)

{{- $modelName := .Model.Name }}
{{- $rawName := .Model.RawName }}
{{- $tableName := .Model.TableName }}
{{- $primaryKey := .Model.PrimaryKey }}


var (
    {{- range .Relations }}
    {{ $rawName }}{{ .Name }}Relation contracts.RelationType = "{{ .Name }}"
    {{- end }}
)

{{- $define := join $rawName "Define" }}
var {{ $define }} {{ $rawName }}Static

type {{ $rawName }}Static struct {
	Hidden []string
	With []contracts.RelationType
	Appends map[string]func(model *{{ $modelName }}) any

  {{- range .Fields }}
  {{ .Name }}Getter func(model *{{ $modelName }}, raw {{ goType . }}) {{ goType . }}
  {{ .Name }}Setter func(model *{{ $modelName }}, raw {{ goType . }}) {{ goType . }}
  {{- end }}

  Saving   func(model *{{ $modelName }}) contracts.Exception
  Saved    func(model *{{ $modelName }})
  Updating func(model *{{ $modelName }}, fields contracts.Fields) contracts.Exception
  Updated  func(model *{{ $modelName }}, fields contracts.Fields)
  Deleting func(model *{{ $modelName }}) contracts.Exception
  Deleted  func(model *{{ $modelName }})
  PrimaryKeyGetter func(model *{{ $modelName }}) any
}

func init() {
    {{- if hasMsgComment .Model "@hidden" }}
    {{ $define }}.Hidden = append(
        {{ $define }}.Hidden,
        {{- range .Fields }}
            {{- if hasComment .Comment "@hidden" }}
            "{{ .JSONName }}",
            {{- end }}
        {{- end }}
     )
    {{- end }}

    {{- if hasMsgComment .Model "@with" }}
    {{ $define }}.With = append(
        {{ $define }}.With,
        {{- range .Relations }}
            {{- if hasComment .Comment "@with" }}
            "{{ .JSONName }}",
            {{- end }}
        {{- end }}
     )
    {{- end }}
}

func New{{ $modelName }}(fields contracts.Fields) *{{ $modelName }} {
  var model = {{ $modelName }}{
    _raw: fields,
  }
  model.Set(fields)
  return &model
}

{{- $queryName := replaceSuffix .Model.Name "Model" "Query" }}
func {{ $queryName }}() *table.Table[{{ $modelName }}] {
  return table.NewQuery("{{ $tableName }}", New{{ $modelName }}).SetPrimaryKey("{{ $primaryKey }}"){{- if ne (len .Relations) 0 }} . {{- end }}
    {{- range .Relations }}
    {{- $relationItemType := goType . }}
    {{- $relationQuery := replaceSuffix $relationItemType "Model" "Query"}}
    {{- $ownerKey := getIndexComment .Comment "@belongsTo" 0 "id" }}
    {{- if hasComment .Comment "@belongsTo" }}
    SetRelation(
    {{ $rawName }}{{ .Name }}Relation,
    			func(item *{{ $modelName }}) any {
    				return item.Get("{{ getIndexComment .Comment "@belongsTo" 1 (join .JSONName "_id") }}")
    			},
    			func(keys []any) map[string][]any {
    				var results = map[string][]any{}
    				for key, values := range {{ $relationQuery }}().WhereIn("{{ $ownerKey }}", keys).Get().GroupBy("id") {
    					results[key] = collection.New(values).ToAnyArray()
    				}
    				return results
    			},
    			func(item *{{ $modelName }}, value []any) {
    			    if len(value) > 0 {
    				    item.Set{{ .Name }}(value[0].(*{{ $relationItemType }}))
    			    } else {
    				    item.Set{{ .Name }}(nil)
    			    }
    			},
    )
    {{- end }}
    {{- end }}
}

{{ toComments .Model.Name .Model.Comments }}
type {{ $modelName }} struct {
  {{- range .Fields }}
  {{- if hasComment .Comment "@belongsTo" }}
  {{- else }}
  {{ .Comments }}
  {{ .Name }} {{ goType . }} `{{ toTags . }}`
  {{- end }}
  {{- end }}

  _raw contracts.Fields
  _update contracts.Fields
  _append contracts.Fields
  _relations contracts.Fields
  _hidden map[string]struct{}
}

func (model *{{ $modelName }}) Hidden(fields ...string) *{{ $modelName }} {
    for _, field := range fields {
        if model._hidden == nil {
            model._hidden = map[string]struct{}{
                field: struct{}{},
            }
        } else {
            model._hidden[field] = struct{}{}
        }

    }

    return model
}

func (model *{{ $modelName }}) Exists() bool {
  return {{ .Model.RawName }}Query().Where("{{ $primaryKey }}", model.GetPrimaryKey()).Count() > 0
}

func (model *{{ $modelName }}) Save() contracts.Exception {
  if model._update == nil {
    return nil
  }
  if {{ $define }}.Saving != nil {
    if err := {{ $define }}.Saving(model); err != nil {
      return err
    }
  }
  _, err := {{ .Model.RawName }}Query().Where("{{ $primaryKey }}", model.GetPrimaryKey()).UpdateE(model._update)
  if err == nil {
    model._update = nil
    if {{ $define }}.Saved != nil {
      {{ $define }}.Saved(model)
    }
  }

  return err
}

func (model *{{ $modelName }}) Set(fields contracts.Fields) {
  for key, value := range fields {

    switch key {
  {{- range .Fields }}
      case "{{ .JSONName }}":
        switch v := value.(type) {
                case {{ goType . }}:
                  model.Set{{ .Name }}(v)
                case func() {{ goType . }}:
                  model.Set{{ .Name }}(v())
                  {{- $type := goType . }}
                  {{- if ne $type "string"}}
                case string:
                  {{- if eq $type "[]byte" }}
                  model.Set{{ .Name }}([]byte(v))
                  {{else}}
                  var vd {{ goType . }}
                  err := json.Unmarshal([]byte(v), &vd)
                  if err != nil {
                      logs.Default().Warn("Failed to Parse field "+key)
                      continue
                  }
                  model.Set{{ .Name }}(vd)
                  {{end}}
                  {{end}}
                  {{- if ne $type "[]byte"}}
                case []byte:
                  {{- if eq $type "string" }}
                  model.Set{{ .Name }}(string(v))
                  {{else}}
                  var vd {{ goType . }}
                  err := json.Unmarshal(v, &vd)
                  if err != nil {
                      logs.Default().Warn("Failed to Parse field "+key)
                      continue
                  }
                  model.Set{{ .Name }}(vd)
                  {{end}}
                  {{end}}
                }
    {{- end }}

    }

  }
}

func (model *{{ $modelName }}) Only(key ...string) contracts.Fields {
  var fields = make(contracts.Fields)
  for _, k := range key {
  {{- range .Fields }}
    if k == "{{ .JSONName }}" {
      fields[k] = model.Get{{ .Name }}()
      continue
    }
  {{- end }}

    if {{ $define }}.Appends[k] != nil {
     fields[k] = {{ $define }}.Appends[k](model)
    }
  }
  return fields
}

func (model *{{ $modelName }}) Get(key string) any {
  {{- range .Fields }}
    if key == "{{ .JSONName }}" {
      return model.Get{{ .Name }}()
    }
  {{- end }}


    if model._append[key] != nil {
      return model._append[key]
    }

    if model._relations[key] != nil {
      return model._relations[key]
    }

  return nil
}

func (model *{{ $modelName }}) Except(keys ...string) contracts.Fields {
  var excepts = map[string]struct{}{}
  for _, k := range keys {
    excepts[k] = struct{}{}
  }
  var fields = make(contracts.Fields)
  for key, value := range model.ToFields() {
    if _, ok := excepts[key]; ok {
      continue
    }
    fields[key] = value
  }
  return fields
}

func (model *{{ $modelName }}) ToFields() contracts.Fields {
  model.Hidden({{ $define }}.Hidden...)

  fields := contracts.Fields{}

    {{- range .Fields }}
    if _,exists := model._hidden["{{ .JSONName }}"]; !exists {
        fields["{{ .JSONName }}"] = model.Get{{ .Name }}()
    }
    {{- end }}

  for key, f := range {{ $define }}.Appends {
    fields[key] = f(model)
  }

  return fields
}

func (model *{{ $modelName }}) Update(fields contracts.Fields) contracts.Exception {

  if {{ $define }}.Updating != nil {
    if err := {{ $define }}.Updating(model, fields); err != nil {
      return err
    }
  }

  if model._update != nil {
    utils.MergeFields(model._update, fields)
  }


  _, err := {{ .Model.RawName }}Query().Where("{{ $primaryKey }}", model.GetPrimaryKey()).UpdateE(fields)

  if err == nil {
    model.Set(fields)
    model._update = nil
    if {{ $define }}.Updated != nil {
      {{ $define }}.Updated(model, fields)
    }
  }

  return err
}

func (model *{{ $modelName }}) Refresh() contracts.Exception {
  fields, err := table.ArrayQuery("{{ $tableName }}").Where("{{ $primaryKey }}", model.GetPrimaryKey()).FirstE()
  if err != nil {
    return err
  }

  model.Set(*fields)
  return nil
}

func (model *{{ $modelName }}) Delete() contracts.Exception {

  if {{ $define }}.Deleting != nil {
    if err := {{ $define }}.Deleting(model); err != nil {
      return err
    }
  }

  _, err := {{ .Model.RawName }}Query().Where("{{ $primaryKey }}", model.GetPrimaryKey()).DeleteE()
  if err == nil && {{ $define }}.Deleted != nil {
    {{ $define }}.Deleted(model)
  }

  return err
}


func (model *{{ $modelName }}) GetPrimaryKey() any {
  if {{ $define }}.PrimaryKeyGetter != nil {
    return {{ $define }}.PrimaryKeyGetter(model)
  }

  return model.{{ toCamelCase $primaryKey }}
}

{{- if .Model.Authenticatable }}
func (model *{{ $modelName }}) GetAuthenticatableKey() string {
  return fmt.Sprintf("%v", model.GetPrimaryKey())
}

func {{ .Model.RawName }}AuthProvider(identify string) contracts.Authenticatable {
  return {{ .Model.RawName }}Query().Find(identify)
}

{{- end }}


{{- range .Fields }}

func (model *{{ $modelName }}) Get{{ .Name }}() {{ goType . }} {
  if {{ $define }}.{{ .Name }}Getter != nil {
    return {{ $define }}.{{ .Name }}Getter(model, model.{{ .Name }})
  }
  return model.{{ .Name }}
}

func (model *{{ $modelName }}) Set{{ .Name }}(value {{ goType . }}) {
  if {{ $define }}.{{ .Name }}Setter != nil {
    value = {{ $define }}.{{ .Name }}Setter(model, value)
  }

  if model._update == nil {
    model._update = contracts.Fields{"{{ .JSONName }}": value}
  } else {
    model._update["{{ .JSONName }}"] = value
  }
  model.{{ .Name }} = value
}

{{- if hasComment .Comment "@carbon" }}
func (model *{{ $modelName }}) Get{{ .Name }}Carbon() carbon.Carbon {
  return carbon.Parse(model.Get{{ .Name }}())
}
{{- end }}


{{- end }}

{{- range .Relations }}

{{- $relationItemType := goType . }}
{{- $relationQuery := replaceSuffix $relationItemType "Model" "Query" }}

{{- if hasComment .Comment "@belongsTo" }}
func (model *{{ $modelName }}) {{ .Name }}() *{{ goType . }} {
    relation, exists := model._relations["{{ .JSONName }}"]
    if !exists {
        value := {{ $relationQuery }}().Where("{{ getIndexComment .Comment "@belongsTo" 0 "id" }}", model.Get("{{ getIndexComment .Comment "@belongsTo" 1 (join .JSONName "_id") }}")).First()
        model.Set{{ .Name }}(value)
        return value
    }
    return relation.(*{{ goType . }})
}

func (model *{{ $modelName }}) Set{{ .Name }}(value *{{ goType . }}) {
    if model._relations == nil {
        model._relations = contracts.Fields{"{{ .JSONName }}": value}
        return
    }
    model._relations["{{ .JSONName }}"] = value
}
{{- end }}

{{- end }}

{{ end }}


{{- define "data" -}}
package {{ .Package }}

import (
{{- range .Imports }}
{{ .Alias }} "{{ .Pkg }}"
{{- end }}
)

type {{ .Model.Name }} struct {
  {{- range .Fields }}
  {{ .Name }} {{ goType . }} `{{ toTags . }}`
  {{- end }}
}

{{ end }}

{{- define "request" -}}
package {{ .Package }}

import (
  {{- range .Imports }}
  {{ .Alias }} "{{ .Pkg }}"
  {{- end }}
  "github.com/goal-web/contracts"
)

type {{ .Model.Name }} struct {
  {{- range .Fields }}
  {{ .Name }} {{ goType . }} `{{ toTags . }}`
  {{- end }}
}

func (model *{{ .Model.Name }}) ToFields() contracts.Fields {
  if model == nil {
    return nil
  }
  fields := contracts.Fields{
  {{- range .Fields }}
    "{{ .JSONName }}": model.{{ .Name }},
  {{- end }}
  }
  return fields
}

{{ end }}

{{- define "result" -}}
package {{ .Package }}
    
import (
  {{- range .Imports }}
  {{ .Alias }} "{{ .Pkg }}"
  {{- end }}
)

type {{ .Model.Name }} struct {
  {{- range .Fields }}
  {{ .Name }} {{ goType . }} `{{ toTags . }}`
  {{- end }}
}

{{ end }}

{{- define "enum" -}}
package {{ .Package }}

{{- $enumName := .Name }}
type {{ .Name }} int
const (
  {{- range .Values }}
  {{- $FieldName := sprintf "%s%s" $enumName .Name }}

  {{ toComments $FieldName .Comments }}
  {{ $enumName }}{{ .Name }} {{ $enumName }} = {{ .Value }}
  {{- end }}
  {{ $enumName }}Unknown {{ $enumName }} = -1000
      
)
  
  
func (item {{ $enumName }}) String() string {
    switch item {
      {{- range .Values }}
        case {{ $enumName }}{{ .Name }}:
          return "{{ .Name }}"
      {{- end }}
        default:
          return "Unknown"
  }
}

func (item {{ $enumName }}) Message() string {
    switch item {
      {{- range .Values }}
        case {{ $enumName }}{{ .Name }}:
          return "{{ .Message }}"
      {{- end }}
        default:
          return "Unknown"
  }
}

func Parse{{ $enumName }}FromString(msg string) {{ $enumName }} {
    switch msg {
    {{- range .Values }}
        case "{{ .Name }}":
          return {{ $enumName }}{{ .Name }}
    {{- end }}
        default:
          return {{ $enumName }}Unknown
  }
}


{{ end }}



{{- define "service" -}}
package {{ .Package }}

import (
  {{- range .Imports }}
  {{ .Alias }} "{{ .Pkg }}"
  {{- end }}
)

{{- $serviceName := .Name }}

{{- range .Methods }}

var {{ $serviceName }}{{ .Name }}Handler func (req *{{ .InputUsageName }}) (*{{ .OutputUsageName }}, error)
func {{ $serviceName }}{{ .Name }}(req *{{ .InputUsageName }}) (*{{ .OutputUsageName }}, error) {
  if {{ $serviceName }}{{ .Name }}Handler != nil {
    return {{ $serviceName }}{{ .Name }}Handler(req)
  }
  return nil, nil
}
{{- end }}
{{ end }}

{{- define "controller" -}}
package {{ .Package }}

import (
  "github.com/goal-web/contracts"
  "github.com/goal-web/validation"
  "{{ .ResponsePath }}"
  svc "{{ .ImportPath }}"
  {{- range .Imports }}
  {{- if notContains .Pkg "results" }}
  {{ .Alias }} "{{ .Pkg }}"
  {{ end -}}
  {{- end }}
)

{{- $serviceName := .Name }}
{{- $prefix := .Prefix }}
func {{ .Name }}Router(router contracts.HttpRouter) {
  routeGroup := router.Group("{{ $prefix }}"{{ toMiddlewares .Middlewares }})
  {{- range .Methods }}
  {{- $controllerMethod := sprintf "%s%s" $serviceName .Name  }}
  {{- $path := .Path  }}
  {{- $middlewares := .Middlewares }}
    {{- range .Method }}
    routeGroup.{{ . }}("{{ $path }}", {{ $controllerMethod }}{{ toMiddlewares $middlewares }})
    {{- end }}
  {{- end }}
}


{{- $usageName := .UsageName }}

{{- range .Methods }}
func {{ $serviceName }}{{ .Name }}(request contracts.HttpRequest) any {
    var req {{ .InputUsageName }}
    
    if err:= request.Parse(&req); err != nil {
      return response.ParseReqErr(err)
    }
    
    if err := validation.Struct(req); err != nil {
      return response.InvalidReq(err)
    }
  
    resp, err := {{ $usageName }}{{ .Name }}(&req)
    if err != nil {
      return response.BizErr(err)
    }
    
    return response.Success(resp)
}
{{- end }}
{{ end }}